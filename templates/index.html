<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyRoute-NeuroGen Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar { background: #f8f9fa; padding: 20px; border-radius: 8px; height: 600px; overflow-y: auto; }
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üöö PyRoute-NeuroGen</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-md-3">
                <div class="sidebar">
                    <h4>Panou Control</h4>
                    <p class="text-muted small">AdaugƒÉ puncte pe hartƒÉ (Bucure»ôti).</p>
                    <div class="d-grid gap-2 mb-3">
                        <button onclick="optimizeRoute()" class="btn btn-primary fw-bold">üöÄ CalculeazƒÉ RutƒÉ</button>
                        <button onclick="resetMap()" class="btn btn-outline-danger">üóëÔ∏è Resetare</button>
                    </div>
                    <hr>
                    <h5>Rezultate:</h5>
                    <h2><span id="time-display">0</span> min</h2>
                    <ul id="route-list" class="list-group list-group-flush small"></ul>
                </div>
            </div>
            <div class="col-md-9"><div id="map"></div></div>
        </div>
    </div>

    <div class="loading-overlay" id="loader">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <h4 class="mt-3">Calculare Traseu...</h4>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([44.435, 26.102], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

        var markers = [];
        var locations = [];
        var routeLine = null;

        var depotIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41] });
        var clientIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41] });

        map.on('click', function(e) {
            var type = locations.length === 0 ? "depot" : "client";
            var icon = locations.length === 0 ? depotIcon : clientIcon;
            
            var marker = L.marker([e.latlng.lat, e.latlng.lng], {icon: icon}).addTo(map);
            markers.push(marker);
            locations.push({ "id": locations.length, "type": type, "lat": e.latlng.lat, "lon": e.latlng.lng });
            
            var list = document.getElementById('route-list');
            list.innerHTML += `<li class="list-group-item">${locations.length}. ${type === 'depot' ? 'Depozit' : 'Client'}</li>`;
        });

        function resetMap() {
            markers.forEach(m => map.removeLayer(m));
            if (routeLine) map.removeLayer(routeLine);
            markers = []; locations = [];
            document.getElementById('route-list').innerHTML = "";
            document.getElementById('time-display').innerText = "0";
        }

        async function optimizeRoute() {
            if (locations.length < 2) { alert("Minim 2 puncte!"); return; }
            document.getElementById('loader').style.display = 'flex';

            try {
                const response = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locations: locations })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('time-display').innerText = data.result.estimated_duration_min;
                    
                    if (routeLine) map.removeLayer(routeLine);
                    
                    if (data.result.detailed_geometry && data.result.detailed_geometry.length > 0) {
                        var polyCoords = data.result.detailed_geometry.map(p => [p.lat, p.lon]);
                        routeLine = L.polyline(polyCoords, {color: 'blue', weight: 5}).addTo(map);
                        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    }
                } else {
                    alert("Eroare: " + data.error);
                }
            } catch (error) {
                console.error(error);
                alert("Eroare server.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }
    </script>
</body>
</html>
