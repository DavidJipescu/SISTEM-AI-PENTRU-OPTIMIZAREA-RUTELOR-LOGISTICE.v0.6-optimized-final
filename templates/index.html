<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyRoute-NeuroGen Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar { background: #f8f9fa; padding: 20px; border-radius: 8px; height: 600px; overflow-y: auto; }
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üöö PyRoute-NeuroGen</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-md-3">
                <div class="sidebar">
                    <h4>Panou Control</h4>
                    <p class="text-muted small">AdaugƒÉ puncte pe hartƒÉ (Bucure»ôti).</p>
                    <div class="d-grid gap-2 mb-3">
                        <button onclick="optimizeRoute()" class="btn btn-primary fw-bold">üöÄ CalculeazƒÉ RutƒÉ</button>
                        <button onclick="resetMap()" class="btn btn-outline-danger">üóëÔ∏è Resetare</button>
                    </div>
                    <hr>
                    <h5>Rezultate:</h5>
                    <h2><span id="time-display">0</span> min</h2>
                    <ul id="route-list" class="list-group list-group-flush small"></ul>
                </div>
            </div>
            <div class="col-md-9"><div id="map"></div></div>
        </div>
    </div>

    <!-- Spinner √ÆncƒÉrcare -->
    <div class="loading-overlay" id="loader">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <h4 class="mt-3">Calculare Traseu...</h4>
        </div>
    </div>

    <!-- LibrƒÉrii Leaflet »ôi PolylineDecorator (pentru sƒÉge»õi) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.4/dist/leaflet.polylineDecorator.min.js"></script>
    
    <script>
        // Ini»õializare hartƒÉ pe Bucure»ôti
        var map = L.map('map').setView([44.435, 26.102], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);

        var markers = [];
        var locations = [];
        var routeLine = null;
        var arrowLayer = null; 

        // Iconi»õe personalizate
        var depotIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41] });
        var clientIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41] });

        // AdƒÉugare puncte la click pe hartƒÉ
        map.on('click', function(e) {
            var type = locations.length === 0 ? "depot" : "client";
            var icon = locations.length === 0 ? depotIcon : clientIcon;
            
            var marker = L.marker([e.latlng.lat, e.latlng.lng], {icon: icon}).addTo(map);
            markers.push(marker);
            locations.push({ "id": locations.length, "type": type, "lat": e.latlng.lat, "lon": e.latlng.lng });
            
            var list = document.getElementById('route-list');
            list.innerHTML += `<li class="list-group-item">${locations.length}. ${type === 'depot' ? 'Depozit' : 'Client'}</li>`;
        });

        // CurƒÉ»õare hartƒÉ
        function resetMap() {
            markers.forEach(m => map.removeLayer(m));
            if (routeLine) map.removeLayer(routeLine);
            if (arrowLayer) map.removeLayer(arrowLayer); 
            markers = []; locations = [];
            document.getElementById('route-list').innerHTML = "";
            document.getElementById('time-display').innerText = "0";
        }

        // Func»õie sigurƒÉ pentru desenarea sƒÉge»õilor
        function drawArrows(targetLine) {
            try {
                arrowLayer = L.polylineDecorator(targetLine, {
                    patterns: [
                        {
                            offset: 30,       
                            repeat: 80,       
                            symbol: L.Symbol.arrowHead({
                                pixelSize: 15, 
                                polygon: false, 
                                pathOptions: {stroke: true, color: '#002266', weight: 3}
                            })
                        }
                    ]
                }).addTo(map);
            } catch (err) {
                console.warn("Nu s-au putut desena sƒÉge»õile:", err);
            }
        }

        // Optimizare »ôi desenare rutƒÉ
        async function optimizeRoute() {
            if (locations.length < 2) { alert("Minim 2 puncte necesare!"); return; }
            document.getElementById('loader').style.display = 'flex';

            try {
                const response = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locations: locations })
                });
                
                // VerificƒÉm dacƒÉ serverul a dat o eroare 500
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Eroare Server (${response.status}): ${errorText}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    // Actualizare timp estimat
                    document.getElementById('time-display').innerText = data.result.estimated_duration_min;
                    
                    // CurƒÉ»õare rute vechi
                    if (routeLine) map.removeLayer(routeLine);
                    if (arrowLayer) map.removeLayer(arrowLayer);
                    
                    if (data.result.detailed_geometry && data.result.detailed_geometry.length > 0) {
                        // RutƒÉ detaliatƒÉ (pe strƒÉzi)
                        var polyCoords = data.result.detailed_geometry.map(p => [p.lat, p.lon]);
                        routeLine = L.polyline(polyCoords, {color: '#0d6efd', weight: 5}).addTo(map);
                        drawArrows(routeLine);
                        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    } else {
                        // Fallback (linie directƒÉ aerianƒÉ) - DacƒÉ backend-ul nu trimite geometria strƒÉzilor
                        console.log("Backend-ul nu a returnat geometria strƒÉzilor. Folosim fallback cu linii drepte.");
                        var simpleCoords = data.result.optimized_stops.map(p => [p.lat, p.lon]);
                        routeLine = L.polyline(simpleCoords, {color: '#0d6efd', weight: 3, dashArray: '5,5'}).addTo(map);
                        drawArrows(routeLine);
                        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    }
                } else {
                    alert("Eroare de la Algoritm: " + data.error);
                }
            } catch (error) {
                console.error("Eroare completƒÉ:", error);
                alert("A apƒÉrut o problemƒÉ: " + error.message);
            } finally {
                // Ascunde mereu overlay-ul de √ÆncƒÉrcare
                document.getElementById('loader').style.display = 'none';
            }
        }
    </script>
</body>
</html>